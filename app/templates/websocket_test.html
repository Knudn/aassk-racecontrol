<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test Page</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .connection-status {
            padding: 10px;
            margin-bottom: 20px;
            background-color: #f8f8f8;
            border-radius: 4px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .room-selection {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .message-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .message-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .message-input input {
            flex-grow: 1;
            padding: 8px;
        }
        .message-input button {
            padding: 8px 15px;
        }
        .log-container {
            border: 1px solid #ddd;
            border-radius: 4px;
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f8f8;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .log-entry pre {
            margin: 0;
            white-space: pre-wrap;
        }
        .send {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .send:hover {
            background-color: #0069d9;
        }
        button {
            padding: 8px 12px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebSocket Test Page</h1>
        
        <div id="connectionStatus" class="connection-status disconnected">
            Status: Disconnected
        </div>
        
        <div class="control-panel">
            <h2>Connection Controls</h2>
            <div>
                <label for="serverUrl">Server URL:</label>
                <input type="text" id="serverUrl" value="http://localhost:5000" style="width: 250px;">
                <button id="connectBtn">Connect</button>
                <button id="disconnectBtn">Disconnect</button>
            </div>
            
            <div class="room-selection">
                <label for="roomSelect">Room:</label>
                <select id="roomSelect">
                    <option value="default">Default (default)</option>
                    <option value="clock_mgnt">Clock Management</option>
                    <option value="socket_retry">Retry Notifications</option>
                </select>
                <button id="joinRoomBtn">Join Room</button>
            </div>
        </div>
        
        <div class="message-area">
            <h2>Messages</h2>
            <div class="message-input">
                <input type="text" id="messageInput" placeholder="Type your message here...">
                <button id="sendBtn" class="send">Send</button>
            </div>
            
            <div class="log-container">
                <div id="eventLog"></div>
            </div>
        </div>
    </div>

    <script>
        // DOM elements
        const connectionStatusEl = document.getElementById('connectionStatus');
        const serverUrlInput = document.getElementById('serverUrl');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const roomSelect = document.getElementById('roomSelect');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const eventLog = document.getElementById('eventLog');
        
        // Socket.io instance
        let socket = null;
        let currentRoom = null;
        
        // Helper functions
        function logEvent(type, data) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const timestamp = new Date().toLocaleTimeString();
            let content = '';
            
            if (typeof data === 'object') {
                content = `<strong>${timestamp} - ${type}:</strong> <pre>${JSON.stringify(data, null, 2)}</pre>`;
            } else {
                content = `<strong>${timestamp} - ${type}:</strong> ${data}`;
            }
            
            entry.innerHTML = content;
            eventLog.appendChild(entry);
            
            // Auto-scroll to bottom
            eventLog.scrollTop = eventLog.scrollHeight;
        }
        
        function updateConnectionStatus(connected) {
            if (connected) {
                connectionStatusEl.className = 'connection-status connected';
                connectionStatusEl.textContent = 'Status: Connected';
            } else {
                connectionStatusEl.className = 'connection-status disconnected';
                connectionStatusEl.textContent = 'Status: Disconnected';
                currentRoom = null;
            }
        }
        
        // Event handlers
        connectBtn.addEventListener('click', () => {
            if (socket) {
                logEvent('Warning', 'Already connected. Disconnect first.');
                return;
            }
            
            const serverUrl = serverUrlInput.value;
            logEvent('System', `Attempting to connect to ${serverUrl}...`);
            
            try {
                socket = io(serverUrl);
                
                socket.on('connect', () => {
                    updateConnectionStatus(true);
                    logEvent('Connection', `Connected with ID: ${socket.id}`);
                });
                
                socket.on('disconnect', () => {
                    updateConnectionStatus(false);
                    logEvent('Connection', 'Disconnected from server');
                });
                
                socket.on('joined', (data) => {
                    currentRoom = data.room;
                    logEvent('Room', `Joined room: ${data.room}`);
                });
                
                socket.on('response', (data) => {
                    logEvent('Response', data);
                });
                
                // Catch all other events
                socket.onAny((event, ...args) => {
                    if (!['connect', 'disconnect', 'joined', 'response'].includes(event)) {
                        logEvent(`Event: ${event}`, args[0]);
                    }
                });
                
            } catch (error) {
                logEvent('Error', `Connection failed: ${error.message}`);
            }
        });
        
        disconnectBtn.addEventListener('click', () => {
            if (!socket) {
                logEvent('Warning', 'Not connected.');
                return;
            }
            
            socket.disconnect();
            socket = null;
            updateConnectionStatus(false);
        });
        
        joinRoomBtn.addEventListener('click', () => {
            if (!socket) {
                logEvent('Warning', 'Not connected. Connect first.');
                return;
            }
            
            const room = roomSelect.value;
            logEvent('Room', `Requesting to join room: ${room}`);
            
            socket.emit('join', { room });
        });
        
        sendBtn.addEventListener('click', () => {
            if (!socket) {
                logEvent('Warning', 'Not connected. Connect first.');
                return;
            }
            
            const message = messageInput.value;
            if (!message) {
                logEvent('Warning', 'Please enter a message.');
                return;
            }
            
            const room = currentRoom || roomSelect.value;
            
            logEvent('Sending', { message, room });
            socket.emit('message', {
                message: message,
                room: room,
                username: 'WebSocketTester'
            });
            
            messageInput.value = '';
        });
        
        // Allow sending with Enter key
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });
    </script>
</body>
</html>